import{easyEws}from"./easyews";const NOTFOUNDYET=0,POSITIVEMATCH=1,NEGATIVEMATCH=2,toAddress="badmail@bardusch.de",positiveMatch="no suspicious activity has been detected",defaultSubject="Suspicious Email Alert";var itemIdRegex=/\{\%\%(.+)\%\%\}/,timeout=!1,timeoutSet=!1,result=0,dataMap=[];function stripHTML(e){var t=document.createElement("div");return t.innerHTML=e,t.textContent||t.innerText||""}function errorCB(e){disableSpinner();var t=document.getElementById("messageBanner");t.querySelector(".ms-MessageBanner-clipper").innerHTML="Something went wrong: "+JSON.stringify(e),t.style.display="none",console.log(e)}function debugCB(e){}function disableSpinner(){document.getElementById("app-body").style.display="",document.getElementById("spinner").style.display="none"}function toggleSpinner(){"none"===document.getElementById("spinner").style.display?(document.getElementById("app-body").style.display="none",document.getElementById("spinner").style.display=""):disableSpinner()}function updateDataMapList(e){document.getElementById("results").innerHTML="",e.forEach(((t,s)=>{easyEws.getMailItem(t.id,(function(e){var s="CheckMark";2==t.result&&(s="AlertSolid");var n='<li class="ms-ListItem">  <i class="ms-Icon ms-Icon--'+s+' ms-font-xl"></i>  <span class="ms-font-m">    <u>'+stripHTML(e.Subject())+"</u>    was marked as harmless.  </span></li>";document.getElementById("results").innerHTML=document.getElementById("results").innerHTML+n}),(e=>errorCB(e)),(e=>debugCB(e))),s>=e.length-1&&(document.getElementById("welcome-features").style.display="none",document.getElementById("results").style.display="")}))}function sendSuspiciousMessage(){var e=Office.context.mailbox.item.itemId;easyEws.getMailItemMimeContent(e,(t=>{easyEws.sendPlainTextEmailWithAttachment(defaultSubject,"{%%"+e+"%%}",toAddress,"Suspicious_Email.msg",t,(function(e){console.log(e)}),(e=>errorCB(e)),(e=>debugCB(e)))}),(e=>errorCB(e)),(e=>debugCB(e)))}function moveItemToDeleted(e){easyEws.moveItem(e,"deleteditems",(function(e){}),(e=>errorCB(e)),(e=>debugCB(e)))}function foundResults(e,t){toggleSpinner(),console.debug("Found result!");var s=t.Body();result=s.search(positiveMatch)<=0?2:1,document.getElementById("result").innerHTML="<b>Result:</b> "+result,moveItemToDeleted(e)}function searchFolderForResults(e,t,s){easyEws.getFolderId(e,(function(e){easyEws.getFolderItemIds(e,(function(e){e.forEach(((t,n)=>{easyEws.getMailItem(t,(o=>s(t,o,n,e.length-1)),(e=>errorCB(e)),(e=>debugCB(e)))}))}),(e=>errorCB(e)),(e=>debugCB(e)),{maxEntries:10,queryString:t})}),(e=>errorCB(e)),(e=>debugCB(e)))}function searchLoop(){setTimeout((()=>{console.debug("Searching for results.."),searchFolderForResults("inbox",'from:"'+toAddress+'" AND received:today',foundResults),timeout||1===result||2===result||searchLoop()}),1e4),timeoutSet||(setTimeout((()=>{1!==result&&2!==result&&(console.debug("Timeout!"),timeout=!0,toggleSpinner())}),36e4),timeoutSet=!0)}function update(){toggleSpinner(),dataMap=[],searchFolderForResults("inbox",'from:"'+toAddress+'" AND received:today',(e=>moveItemToDeleted(e))),searchFolderForResults("sentitems",'to:"'+toAddress+'" AND received:today',((e,t,s,n)=>{var o=t.Body().match(itemIdRegex);o&&o.length>0&&dataMap.push({id:o[1],result:0}),s>=n&&searchFolderForResults("deleteditems",'from:"'+toAddress+'" AND received:today',((e,t,s,n)=>{var o=t.Body(),r=o.match(itemIdRegex);r&&r.length>0&&dataMap.forEach(((e,t)=>{e.id===r[1]&&(o.search(positiveMatch)<=0?dataMap[t].result=2:dataMap[t].result=1)})),s>=n&&(updateDataMapList(dataMap),toggleSpinner())}))}))}Office.onReady((e=>{if(e.host===Office.HostType.Outlook){document.getElementById("mail-subject").innerHTML=stripHTML(Office.context.mailbox.item.subject),document.getElementById("app-body").style.display="flex",document.getElementById("run").onclick=run,document.getElementById("update").onclick=update;for(var t=document.querySelectorAll(".ms-Spinner"),s=0;s<t.length;s++)new fabric.Spinner(t[s]);var n=document.getElementById("messageBanner");n.querySelector(".ms-MessageBanner-close").addEventListener("click",(()=>{setTimeout((()=>{n.style.display="none"}),500)})),searchFolderForResults("inbox",'from:"'+toAddress+'" AND received:today',(e=>moveItemToDeleted(e)))}}));export async function run(){toggleSpinner(),result=0,sendSuspiciousMessage(),searchLoop()}